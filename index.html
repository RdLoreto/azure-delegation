<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Onboarding Delegação Billing Azure</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      max-width: 600px;
    }
    input {
      font-size: 1rem;
      padding: 0.4rem;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      font-size: 1rem;
      padding: 0.6rem 1.2rem;
      margin-top: 1rem;
      cursor: pointer;
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
    }
    #status {
      margin-top: 1rem;
      background: #f3f3f3;
      padding: 1rem;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>Delegação de acesso Billing Azure</h1>
  <p>Informe seu <strong>Subscription ID</strong> para iniciar a delegação:</p>
  <input
    type="text"
    id="subscriptionId"
    placeholder="Ex: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    autocomplete="off"
    spellcheck="false"
  />
  <button id="btnDelegate" disabled>Delegar acesso (Billing Reader)</button>

  <div id="status" aria-live="polite"></div>

  <script>
    const btn = document.getElementById('btnDelegate');
    const input = document.getElementById('subscriptionId');
    const status = document.getElementById('status');

    // Valida se é um GUID simples (não perfeito, mas suficiente)
    function isValidGuid(guid) {
      return /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$/.test(guid);
    }

    input.addEventListener('input', () => {
      const val = input.value.trim();
      btn.disabled = !isValidGuid(val);
      status.textContent = '';
    });

    btn.onclick = () => {
      const subId = input.value.trim();
      if (!isValidGuid(subId)) {
        status.textContent = 'Subscription ID inválido.';
        return;
      }

      const templateUri =
        'https://raw.githubusercontent.com/RdLoreto/azure-delegation/main/delegation.json';
      const encodedTemplateUri = encodeURIComponent(templateUri);
      const url = `https://portal.azure.com/#create/Microsoft.Template/uri/${encodedTemplateUri}`;

      status.innerHTML = `
        <strong>Atenção:</strong><br/>
        Você será redirecionado para o portal Azure para aceitar a delegação.<br/>
        Depois que concluir, retorne a esta página.<br/>
        <a href="${url}" target="_blank" rel="noopener noreferrer">Abrir Azure Portal para delegar acesso</a>
      `;

      window.open(url, '_blank');
    };
  </script>
</body>
</html>
