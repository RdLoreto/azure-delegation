<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check Billing Reader Access</title>
  <script src="https://alcdn.msauth.net/browser/2.34.0/js/msal-browser.min.js"></script>
</head>
<body>
  <h1>Check Billing Reader Permission</h1>

  <label for="subscriptionId">Client Subscription ID:</label>
  <input type="text" id="subscriptionId" placeholder="Enter subscription ID" style="width:300px" />
  <br /><br />

  <button id="loginBtn">Login and Check Access</button>

  <pre id="result" style="margin-top:20px; white-space: pre-wrap;"></pre>

  <script>
    const msalConfig = {
      auth: {
        clientId: "be316639-ba4e-4d14-b856-44010cfd84e4", // Your SaaS app client ID
        redirectUri: window.location.origin,
        authority: "https://login.microsoftonline.com/common", // multi-tenant
      },
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);
    const loginBtn = document.getElementById("loginBtn");
    const resultDiv = document.getElementById("result");

    const scopes = ["https://management.azure.com/user_impersonation"];

    loginBtn.onclick = async () => {
      const subscriptionId = document.getElementById("subscriptionId").value.trim();
      if (!subscriptionId) {
        alert("Please enter a subscription ID");
        return;
      }

      try {
        // Login popup to get account
        const loginResponse = await msalInstance.loginPopup({ scopes });
        const account = loginResponse.account;
        msalInstance.setActiveAccount(account);

        // Acquire token silently or via popup if needed
        const tokenResponse = await msalInstance.acquireTokenSilent({
          scopes,
          account,
        }).catch(async (error) => {
          // fallback to popup if silent fails
          if (error instanceof msal.InteractionRequiredAuthError) {
            return msalInstance.acquireTokenPopup({ scopes, account });
          } else {
            throw error;
          }
        });

        const accessToken = tokenResponse.accessToken;

        // Call Role Assignments API to check Billing Reader role assignment
        // Billing Reader role definition ID:
        const billingReaderRoleDefinitionId = "b24988ac-6180-42a0-ab88-20f7382dd24c";

        // API endpoint to list role assignments for current principal on the subscription
        const roleAssignmentsUrl = `https://management.azure.com/subscriptions/${subscriptionId}/providers/Microsoft.Authorization/roleAssignments?api-version=2022-04-01&$filter=principalId eq '${account.homeAccountId.split('.')[0]}' or principalName eq '${account.username}'`;

        // Actually, the best way is to check all assignments and filter by roleDefinitionId (Billing Reader)

        const roleAssignmentsResponse = await fetch(
          `https://management.azure.com/subscriptions/${subscriptionId}/providers/Microsoft.Authorization/roleAssignments?api-version=2022-04-01`,
          {
            headers: {
              Authorization: `Bearer ${accessToken}`,
              "Content-Type": "application/json",
            },
          }
        );

        if (!roleAssignmentsResponse.ok) {
          throw new Error(`API call failed: ${roleAssignmentsResponse.status} ${roleAssignmentsResponse.statusText}`);
        }

        const roleAssignmentsJson = await roleAssignmentsResponse.json();

        // Filter role assignments for billing reader role and for our principalId or userId
        const hasBillingReader = roleAssignmentsJson.value.some((ra) =>
          ra.properties.roleDefinitionId.toLowerCase().endsWith(billingReaderRoleDefinitionId) &&
          (ra.properties.principalId.toLowerCase() === account.homeAccountId.split('.')[0].toLowerCase() || ra.properties.principalName?.toLowerCase() === account.username.toLowerCase())
        );

        resultDiv.textContent = hasBillingReader
          ? `You HAVE Billing Reader access on subscription ${subscriptionId}`
          : `You DO NOT have Billing Reader access on subscription ${subscriptionId}`;
      } catch (e) {
        resultDiv.textContent = "Error: " + e.message;
      }
    };
  </script>
</body>
</html>
