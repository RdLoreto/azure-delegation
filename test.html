<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Validar Delegação Azure Lighthouse</title>
  <script src="https://alcdn.msauth.net/browser/2.37.0/js/msal-browser.min.js"></script>
</head>
<body>
  <h1>Validar Permissão via Azure Lighthouse</h1>
  <button id="loginBtn" onclick="signIn()">Entrar com Azure</button>

  <div id="subscriptionSelector" style="margin-top:20px; display:none;">
    <label for="subscriptions">Selecione a subscription:</label>
    <select id="subscriptions"></select>
    <button onclick="validateDelegation()">Validar Delegação</button>
  </div>

  <div id="result" style="margin-top: 20px;"></div>

  <script>
    const tenantId = "d9106a5f-485c-4821-b34e-a4b19f02a841"; // Seu tenant ID
    const clientId = "be316639-ba4e-4d14-b856-44010cfd84e4"; // Seu Application (client) ID
    const appPrincipalObjectId = "cbf50ce3-299c-4dec-ae5e-39f9c5b96995"; // Object ID do Service Principal do app

    let msalInstance;
    let account;
    let accessToken;
    
    const msalConfig = {
      auth: {
        clientId: clientId,
        authority: `https://login.microsoftonline.com/${tenantId}`,
        redirectUri: location.href
      }
    };

    msalInstance = new msal.PublicClientApplication(msalConfig);

    async function signIn() {
      try {
        const loginResponse = await msalInstance.loginPopup({
          scopes: ["https://management.azure.com/user_impersonation"]
        });
        account = loginResponse.account;

        const tokenResponse = await msalInstance.acquireTokenSilent({
          account: account,
          scopes: ["https://management.azure.com/user_impersonation"]
        });

        accessToken = tokenResponse.accessToken;

        document.getElementById("loginBtn").style.display = "none";
        await loadSubscriptions();
      } catch (err) {
        document.getElementById("result").innerText = "Erro de login: " + err;
      }
    }

    async function loadSubscriptions() {
      const url = `https://management.azure.com/subscriptions?api-version=2020-01-01`;
      const response = await fetch(url, {
        headers: { Authorization: `Bearer ${accessToken}` }
      });

      if (!response.ok) {
        const errorText = await response.text();
        document.getElementById("result").innerHTML = `<p style="color:red;">Erro ao buscar subscriptions: ${response.status} - ${errorText}</p>`;
        return;
      }

      const data = await response.json();
      const subscriptions = data.value;

      if (subscriptions.length === 0) {
        document.getElementById("result").innerHTML = "<p>Nenhuma subscription encontrada.</p>";
        return;
      }

      const select = document.getElementById("subscriptions");
      select.innerHTML = "";
      subscriptions.forEach(sub => {
        const option = document.createElement("option");
        option.value = sub.subscriptionId;
        option.textContent = `${sub.displayName} (${sub.subscriptionId})`;
        select.appendChild(option);
      });

      document.getElementById("subscriptionSelector").style.display = "block";
    }

    async function validateDelegation() {
      const subscriptionId = document.getElementById("subscriptions").value;
      document.getElementById("result").innerHTML = "Validando delegação...";

      const url = `https://management.azure.com/subscriptions/${subscriptionId}/providers/Microsoft.ManagedServices/registrationAssignments?api-version=2022-10-01`;

      try {
        const response = await fetch(url, {
          headers: {
            Authorization: `Bearer ${accessToken}`
          }
        });

        if (!response.ok) {
          const errorText = await response.text();
          document.getElementById("result").innerHTML = `<p style="color:red;">Erro ao buscar delegações: ${response.status} - ${errorText}</p>`;
          return;
        }

        const data = await response.json();
        const assignments = data.value;

        const found = assignments.find(assignment => {
          const authorizations = assignment.properties.authorizations || [];
          return authorizations.some(auth => auth.principalId.toLowerCase() === appPrincipalObjectId.toLowerCase());
        });

        document.getElementById("result").innerHTML = found
          ? `<p style="color:green;">✅ A aplicação <b>PocBillingReader</b> possui delegação via Azure Lighthouse nesta subscription.</p>`
          : `<p style="color:red;">❌ A aplicação NÃO possui delegação via Azure Lighthouse nesta subscription.</p>`;
      } catch (err) {
        document.getElementById("result").innerHTML = `<p style="color:red;">Erro na validação: ${err}</p>`;
      }
    }
  </script>

  <!--
  PARA EVITAR O ERRO "ADMIN APPROVAL REQUIRED":
  1. Copie e cole no navegador o link abaixo (substitua tenantId e clientId):
  https://login.microsoftonline.com/d9106a5f-485c-4821-b34e-a4b19f02a841/adminconsent?client_id=be316639-ba4e-4d14-b856-44010cfd84e4

  2. Faça login como Global Admin e aceite as permissões para o aplicativo.
  3. Depois disso, o login via popup no app funcionará sem pedir aprovação.
  -->
</body>
</html>
